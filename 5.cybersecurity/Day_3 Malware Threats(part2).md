

# Windows security(exculsion)

- Add or remove items that you want to exclude from microsoft defender antivirus scans.
- Therefore, Hackers use this place for adding their malicious items, so it wont be scan by anti-virus.
# Malware Attack CounterMeasures

● **Identify the Type of Malware:**
- Ransomware, file deletion, data corruption, or exfiltration...
- To **know about malware families** use: www.malpedia.caad.fkie.fraunhofer.de
- **Assess Damage**:  Determine what data has been encrypted, corrupted, or deleted.
- Immediately **Disconnect Internet**
- If you Have Any Saved Passwords on your browser, Try to change Password of all the Accounts. use password managers like Proton.
- Try to **Remove Any Background Running Program**. - You can do this Using **task Manager.**
- Try to **Remove Any software** you Installed Recently From **suspicious Place.**
- Remove Any document you Copied to You system recently.
- Check Your Email if you got any suspicious Texts.


## Malware attack recovery

#### Data Recovery Steps

- **Step** 1: **Restore from Backup**s: ○ Use the **most recent unaffected backup** to recover data. ○ Ensure backups are verified and clean before restoring.
- **Step** 2: **Use Recovery Tools:** Employ professional recovery tools for partially corrupted or deleted files. **EG**. **Recuva**, **EaseUS Data Recovery**, or **enterprise-grade solutions**. 
- **Step** 3: **Work with Vendors:** Engage backup and recovery solution vendors if specialized tools or expertise are needed. **eg**: **Backups from Ethio-telecom**. 
- **Step** 4: **Patch and Secure**: Update all systems and software to prevent a recurrence


## Address Ransomware-Specific Scenarios

- ● **Do Not Pay the Ransom**: Paying does not guarantee data recovery and may encourage further attacks.

- **Use Decryption Tools**: Check for **publicly available decryptors** (e.g., No More Ransom initiative). i. https://www.nomoreransom.org/en/decryption-tools.html 

- **Contact Authorities:** Report the incident to local cybercrime agencies or CERTs. 


# Malware in History

1. **Morris Worm**: o known as the Internet worm, **first computer worms** to spread via the Internet and earn notoriety in the media.

2. **ILOVEYOU Virus:** **eg**. *links in telegram..* written with VBS. viruss infected tens of millions of computers globally. 

3. **Stuxnet Worm:** even physical attacks, for Iran nuclear with USB. It is a worm and holds 4 vulnerabilities. Some experts believe this sophisticated worm was developed for years to launch a cyberattack.

4. **WannaCry**: is a ransomware which targeted **computers running the Microsoft Windows** operating system by **encrypting (locking) data** and demanding ransom payments in the **Bitcoin cryptocurrency**. 


# Python for Malware development

First we have to understand what our malware have to do. ● There are so many kinds of malware purpose 
- ○ Delete files 
- ○ Encrypt files 
- ○ Corrupt files 
- ○ …
   - **NB**. Then You can **Convert your python file to executable(exe)** by **py2exe** technics.   **Use**: (**Py2exe**, **py compiler**). or Use the linux command to change py to exe.


## Malware #1 - File deleting malware

- The algorithm is simple
- The file being deleted is based on our plan, but - if the **file needs root access** then we need to build the **rootkit** too. 
- ● For simplicity, i will show you making a simple python program that will delete files in a folder which it is opened.
- Lets create a test folder and our virus.py file
- Also let’s create some random files for test.

#### Starter

- Open your Vscode.
- Or, in linux use text editors. or
- Run: **`python`**   then you can use the terminal for python code.
- **Import os package**: `import os`   ..to: remove, rename, unlink, chdir, environ, system.. and also to: abort, access, add_all_directory, altsep, chmod, close..
- **OS package** is a module that helps us to **interact and do some Terminal commands** because as you know python is not like bash and cant run shell commands directly.
- **`os.listdir()`**     ..list files and directories.. like `ls`. but lists in list datatype.
- **`for i in os.listdir()`**   ..lists vertically.
- **`os.system()`**    ...run linux commands in python terminal. **eg**. **`os.system(echo "Hello world!")`** 
- **`os.path.isfile("Desktop")`**   ...returns False. bc Desktop is not file.
- **`os.remove()`**  ...to **remove a File**.
- **`os.removedirs()`**  ..to **remove Directory**. 
  - **NB**. For speed and to not been detected: use c# for windows API call and windows system call, and also use **"c" or assembly language**.
#### Coding
- Make sure you run them in the right test folder. And go to that folder on your terminal/powershell
```
import os

files = []
folders = []

for file in os.listdir():
	if file != "remove_virus.py":
		if os.path.isfile(file):
			files.appent(file)
		else:
			folders.append(file)
	else:
		pass
for i in files:
	os.remove(i)
for j in folders:
	os.folders(j)
	
```

Look 1st there were folders and files then boom after running our virus those f iles are removed. 
This is the main concept between some file viruses.


### Exercise 1

**Write a virus that creates 20 files with name virus_1 virus_2… a**. Use os.system(“your shell code”) => you can use f” { variable }” as the print function
```
import os

for i in range(1, 21):
	os.system(f"touch virus_{i}")
```


# File Handling in python

● Files Used to Store Data in Storage Devices.<br>
● In Python ,a File Operation takes place in the following order: 
- ○ Open a File
- ○ Read or Write(perform operation) 
- ○ Close the file

● Python has a built-in function called open(). 
- ● Syntax: ○ with open(“fileName or filePath”,’x’) as var br,
- ● Modes: 
	- ○ write---------------------------------w 
	- ○ read---------------------------------r 
	- ○ append---------------------------a 
	- ○ Create----------------------------- x 
	- ○ text mode-------------------------t 
	- ○ binary mode---------------------b
- **Example**: ○ `with open(“fileName”,’w’) as var: `
- ○` with open(“fileName”,’rt’) as var:-> rt ~ r`

#### Write on Files
In order to write on file we have to open it in write, append, creation mode.
- Warning: Be sure when you use ‘w’ because it will overwrite the existing file. SO use Append ‘a
- **Syntax**: `var.write(“Hello world”)`
```
with open("note.txt", 'w') as file:
	file.write("Hello!!, this is my note")
```

#### Reading files
To read files on python we have to open it by reading mode ’r'.
- read() - >This read file up to the inputted size number.BUT if you don’t add the size it will read it until the end.
- readline() -> To read files only one line
- readlines() -> reads all file in 1 line
- **Syntax**: 
```
	○ var.read(5) 
	○ var.readline() 
	○ var.readlines()
```
eg. 
```
with open("notes.txt", 'r') as note:
	a = note.read()
	print(a)
```

#### Creating file
You just need to add the x on the type.
- But be sure if the file exists there will be File exists error.
- To pass this use the following…Checking existence.

#### Checking existence.
To check if the file is created before:

```
import os

if os.path.exists(“notes.txt”):
	print(“the file already exist!”)
else:
	print(“no file!”)

```


### Malware #2 - File Ransomware

Here we are going to do our own ransomware.
- So how do **ransomware** words…. Algorithm?
	- ○ They scan the system files 
	- ○ They will encrypt them with some key 
	- ○ Done!
- ● We can do the **decrypter** to 
	- ○ It accepts the key 
	- ○ Decrypt the system files
- For our example we just encrypt and decrypt of files in our test folder.
- First install cryptography: **`pip install cryptography`**
- For this we can use **Fernet module** from **cryptography package**.
## coding our ransom
- It is simple don’t worry.
#### code for encryption

```
```

#### code for decryption
The code is almost same, Just small modification on the decrypt variable.
```
```

# Malware Analysis

- Malware analysis is a process of analyzing malwares.
- The purpose of malware analysis is usually to provide the information you need to respond to a network intrusion.
- Your goals will typically be to determine exactly what happened, and to ensure that you’ve located all infected machines and files.
- The Analysis is Done on the a. Artifact/Sample.
	- a.  **Artifact**: It is A Malware Sample Taken from an Infected System.
- Person Who does The Analysis is called **Malware Analyst**.


## Malware Analysis Techniques

Most often, when performing malware analysis, you’ll have only the malware **executable**, which **won’t be human-readable**.

- In order to make sense of it, you’ll use a variety of tools and tricks, each revealing a small amount of information.
- There are two fundamental approaches to malware analysis:
	- **Static Analysis**
	- **Dynamic Analysis**

# 1. Static Malware Analysis

This is A method of analysing the Malware without Running.
- ○ Basic Static Analysis 
- ○ Advanced Static Analysis


## A. Basic static analysis

- Examining the executable file without viewing the actual instructions.
- Basic static analysis can confirm whether a file is malicious, provide information about its functionality, and sometimes provide information that will allow you to produce simple network signatures.
- Basic static analysis is straightforward and can be quick, but it’s largely ineffective against sophisticated malware.
- **Things Done** 
	- ○ Antivirus Scanning 
	- ○ Getting the Signature of Malware 
	- ○ Checking if the Attacker used packer on it 
	- ○ Checking the **Signature** on Different Scanning websites, like: **VirusTota**

### VirusTotal

- Will Check For Files With Upload or Their Hash.
- This can scan the malware files and even links also.
- Check for links, Also Hackers Use it to get more information by searching Keywords when they Perform OSINT
- Link: https://www.virustotal.com
- Therefore, it tells about how many Antiviruses scanned the virus.
- **Additionally**, It has a search bar when you search a link it will tells you about the link and its subdomains and other Informations.. like OSINT.


### Hybrid Analysis

**Hybrid Analysis**: This is a free malware analysis service for the community that detects and analyzes unknown threats using a unique Hybrid Analysis technology
- https://www.hybrid-analysis.com/


## B. Advanced Static Analysis

- It needs the knownladge of C, Assembly, Reverse-Engineering.
- Advanced static analysis consists of reverse-engineering the malware’s internals by loading the executable into a **disassembler**(Softwares for **Reversing**) and looking at the program instructions in order to discover what the program does. 
- **Disassembler** eg: **GHIDRA**
- In **Ghidra**, when you enter(import) the malicious code(**Virus**), it makes a reverse code with C and assemnly language.


## Analysis of Vega Stealer

The Vega Stealer payload was delivered via a **document containing malicious macros**.

- One of the goals of Vega appears to be **gathering and exfiltrating saved data from the Google Chrome browser**, **including**:
	- ○ **Passwords** (the “logins” SQLite table contains URLs and username and password pairs) 
	- ○ **Saved credit cards** (the “credit_cards” autofill table contains name, expiration date, and card number) 
	- ○ **Profiles** (the “autofill_profile_names” table contains first, middle, and last name) 
	- ○ **Cookies**

- When Blue teamers Analyze the Payload with “**dotpeek**” To Learn More on .NET Reverse Engineering: https://medium.com/@tr15t4n/intro-to-net-reverse-engineering-c54823b22d6f
- Vega also takes a screenshot of the infected machine.


# 2. Dynamic Malware Analysis

This is A Analyzing technique by **Executing/Running** the Malware.

- ● There are Two Kinds 
	- ○ Basic Dynamic Analysis 
	- ○ Advanced Dynamic Analysis


### A. Basic Dynamic Analysis

- In **sandbox**, s involve running the malware and observing its behavior on the system in order to remove the infection, produce effective signatures, or both.
- Like basic static analysis techniques, basic dynamic analysis techniques can be used by most people **without deep programming knowledge**, but they **won’t be effective with all malware** and can **miss important functionality**.


### B. Advanced Dynamic Analysis

- uses a debugger to examine the internal state of a running malicious executable.
- provide another way to extract detailed information from an executable.
- These techniques are most useful when you’re trying to obtain information that is difficult to gather with the other techniques.
- We can Use Tools, To Capture any Requests Triggered from the Malware, We can see Which **Module/Library is Trying to Call**.
- **Tools** Like: 
	- **Sysinternal Suite**: https://learn.microsoft.com/en-us/sysinternals/ - when run a virus If it creates any processes, This will registers.
	- **Gdb**: https://en.wikipedia.org/wiki/GNU_Debugger
	- **strace**: This is a linux tool: `strace python virus.py`  ..This shows the detail works of the virus.
<br>
**NB**. In Dynamic Analysis, When we run the virus, also **network checking** will be takes place. so, We can Know the Host(Hacker)'s IP.

## IOC (Indicator of compromise) Time

This is like a report, If you get a malware. so, Read more about IOC.

<br>
**NB**. If you are interested about Malware Analysis, Read the Book:  **Practical Malware Analysis** 
- "The hands-on guide to Dissecting Malicious software." 
- **BY**: **Michael Sikorski and Andrew Hong**. Forwarded by **Richard Bejtlich**

